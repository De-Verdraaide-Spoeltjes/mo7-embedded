#include "audiofilters.h"

#include "xscugic.h"
#include "xscutimer.h"
#include "xtime_l.h"

#include "audioController.h"
#include "defines.h"

#define UPPER_MIDS_LENGTH 	51
const double upperMidsCoefficients[UPPER_MIDS_LENGTH] = {
	0.03171485715822,  0.01665051764101,  0.01619722522076,  0.01242054017441,
   0.006179524277911,-0.0007105809395844,-0.006053611002738,-0.007975518658629,
  -0.005732910812888,-0.0001291766825747, 0.006445281401913,  0.01064626004968,
   0.009123922304965,-0.0001988943079939, -0.01721498925352,  -0.0391427816292,
   -0.06097462269142, -0.07650766930455, -0.08001261688868, -0.06794177283998,
   -0.04008817890798,-0.0002120593620074,  0.04465558413906,  0.08573782543039,
     0.1145289157087,   0.1248738555486,   0.1145289157087,  0.08573782543039,
    0.04465558413906,-0.0002120593620074, -0.04008817890798, -0.06794177283998,
   -0.08001261688868, -0.07650766930455, -0.06097462269142,  -0.0391427816292,
   -0.01721498925352,-0.0001988943079939, 0.009123922304965,  0.01064626004968,
   0.006445281401913,-0.0001291766825747,-0.005732910812888,-0.007975518658629,
  -0.006053611002738,-0.0007105809395844, 0.006179524277911,  0.01242054017441,
    0.01619722522076,  0.01665051764101,  0.03171485715822
};

#define PRESENCE_LENGTH 51
const double presenceCoefficients[PRESENCE_LENGTH] = {
    0.00372019215702136443052472358772320149,
    -0.000492577268638062543311406660251350331,
    0.006765032445048032097578705190699110972,
    0.018139018257523755600635340101689507719,
    0.02106123617285497393036841629054833902,
    0.009155070206171938423933553963252052199,
    -0.011565021091156167665214837825260474347,
    -0.027084252632767896740162427704490255564,
    -0.026878337524249333589931865162725443952,
    -0.012852024511362252975898989859615539899,
    0.002141379657675089413781943648018568638,
    0.005495692500482409793838289857603740529,
    -0.003430419488926570760478629296130748116,
    -0.011498123785303591970485825868308893405,
    -0.002694175661656878634220291246492706705,
    0.026200131930988267148219250657348311506,
    0.058339774570498062478129952523886458948,
    0.06585576970678798380820495594889507629,
    0.030632404808589034500565517760151124094,
    -0.038084015511829660827203269946039654315,
    -0.103837037629437176078361915187997510657,
    -0.123663011014820106714395819835772272199,
    -0.076887546620327207325118479275261051953,
    0.017822021066199008471064857417331950273,
    0.110354863678279110916768956940359203145,
    0.148533163975029774972469454041856806725,
    0.110354863678279110916768956940359203145,
    0.017822021066199008471064857417331950273,
    -0.076887546620327207325118479275261051953,
    -0.123663011014820106714395819835772272199,
    -0.103837037629437176078361915187997510657,
    -0.038084015511829660827203269946039654315,
    0.030632404808589034500565517760151124094,
    0.06585576970678798380820495594889507629,
    0.058339774570498062478129952523886458948,
    0.026200131930988267148219250657348311506,
    -0.002694175661656878634220291246492706705,
    -0.011498123785303591970485825868308893405,
    -0.003430419488926570760478629296130748116,
    0.005495692500482409793838289857603740529,
    0.002141379657675089413781943648018568638,
    -0.012852024511362252975898989859615539899,
    -0.026878337524249333589931865162725443952,
    -0.027084252632767896740162427704490255564,
    -0.011565021091156167665214837825260474347,
    0.009155070206171938423933553963252052199,
    0.02106123617285497393036841629054833902,
    0.018139018257523755600635340101689507719,
    0.006765032445048032097578705190699110972,
    -0.000492577268638062543311406660251350331,
    0.00372019215702136443052472358772320149
};

#define BRILLIANCE_LENGTH 51
const double brillianceCoefficients[BRILLIANCE_LENGTH] = {
    0.01360983433774,-0.001390312836548, -0.02141435929172, -0.01730289178319,
    0.01065168665208,  0.02070789487506, 0.002958579558854,-0.005687400333269,
  0.0007499545829186, -0.01225075406956, -0.03144361549241,-0.002752778261863,
    0.04969300357062,  0.03829936894219, -0.02705250208292, -0.04253784981771,
  -0.001709705875027,-0.001487119806453, -0.02962358024723,  0.02654570047046,
     0.1148413818324,    0.041347725854,  -0.1550363215519,  -0.1702792956594,
    0.07377564400655,   0.2366929872459,  0.07377564400655,  -0.1702792956594,
    -0.1550363215519,    0.041347725854,   0.1148413818324,  0.02654570047046,
   -0.02962358024723,-0.001487119806453,-0.001709705875027, -0.04253784981771,
   -0.02705250208292,  0.03829936894219,  0.04969300357062,-0.002752778261863,
   -0.03144361549241, -0.01225075406956,0.0007499545829186,-0.005687400333269,
   0.002958579558854,  0.02070789487506,  0.01065168665208, -0.01730289178319,
   -0.02141435929172,-0.001390312836548,  0.01360983433774
};

#define OPEN_AIR_LENGTH 51
const double openAirCoefficients[OPEN_AIR_LENGTH] = {
    -0.030051293213254465924721969827260181773,
    -0.000000589137342034173266074438893302734,
    0.009382847348008706636623976748978748219,
    -0.000002111910903899052532423042879972108,
    -0.010982409945016740476786409885789908003,
    -0.000003677552372828982437465324129011179,
    0.012900365957508557260280390721618459793,
    -0.000002423764299078310495720502831806797,
    -0.015205305797386830732320639469890011242,
    -0.00000498041208103053541694565584108112 ,
    0.018069162909561946317449354637574288063,
    0.00000192661982768196098005520494611531,
    -0.02170891984787243905730136361853510607 ,
    -0.000001814136916851531539663093701986174,
    0.02655861540149391866738604051079164492,
    -0.000002692545631650373165336467828900879,
    -0.033387761329044376990005105199088575318,
    -0.000002264093640670840633421015408721644,
    0.043946759710734736859016891230567125604,
    -0.000007049317306996566757384091450600039,
    -0.062538578918473849976855660770524991676,
    -0.000014222251242023654376638898411133738,
    0.105444657391771612342523667393834330142,
    -0.000010757312666104191302722178913420237,
    -0.318083912224213616326551345991902053356,
    0.500002157465675556302642235095845535398,
    -0.318083912224213616326551345991902053356,
    -0.000010757312666104191302722178913420237,
    0.105444657391771612342523667393834330142,
    -0.000014222251242023654376638898411133738,
    -0.062538578918473849976855660770524991676,
    -0.000007049317306996566757384091450600039,
    0.043946759710734736859016891230567125604,
    -0.000002264093640670840633421015408721644,
    -0.033387761329044376990005105199088575318,
    -0.000002692545631650373165336467828900879,
    0.02655861540149391866738604051079164492,
    -0.000001814136916851531539663093701986174,
    -0.02170891984787243905730136361853510607,
    0.00000192661982768196098005520494611531,
    0.018069162909561946317449354637574288063,
    -0.00000498041208103053541694565584108112 ,
    -0.015205305797386830732320639469890011242,
    -0.000002423764299078310495720502831806797,
    0.012900365957508557260280390721618459793,
    -0.000003677552372828982437465324129011179,
    -0.010982409945016740476786409885789908003,
    -0.000002111910903899052532423042879972108,
    0.009382847348008706636623976748978748219,
    -0.000000589137342034173266074438893302734,
    -0.030051293213254465924721969827260181773
};


#define AUDIO_BUFFER_SIZE 51
int audioBufferIndex = 0;
audioData audioBuffer[AUDIO_BUFFER_SIZE];

#define FILTER_LENGTH 51
double coefficients[FILTER_LENGTH] = {0.0};

#define FILTER_COUNT 4

void calculateCoefficients();
double filterCoefficient(const double *coefficients, int filterLength, int index);
void runFilters();
void sumAudio(audioData *result, audioData *audioIn, int length);
void firFilter(audioData *result, const float *coefficients, int filterLength);
void volumeBoost(audioData *audio, float volumeFactor);
void addToAudioBuffer(audioData *audio);
void getFromAudioBuffer(audioData *audio, int decr);


#ifdef PRINT_DURATION
static const volatile void Duration() {
	static XTime last_sample_time = 0;
	static u32 count_2 = SAMPLE_RATE / 2;
	XTime sample_time = 0;
	XTime_GetTime(&sample_time);

    static uint8_t recalc = 0;

	u32 time_diff = sample_time - last_sample_time;
	last_sample_time = sample_time;

	if (count_2 > SAMPLE_RATE) {
		count_2 = 0;
		xil_printf("Time between samples: %d\t | On time: ", time_diff);
        if (TIME_TO_US(time_diff) <= INTERRUPT_PERIOD_US) {
            xil_printf("Yes\r\n");
        } else {
            xil_printf("No\r\n");
        }
        recalc++;
	}
	count_2++;

    if (recalc >= 10) {
        recalc = 0;
        XTime start, stop;
        XTime_GetTime(&start);
        calculateCoefficients();
        XTime_GetTime(&stop);
        u32 duration = stop - start;
        xil_printf("Duration of coefficient calculation: %d\r\n", duration);
    }

}
#endif

// Handle the interrupt logic
void audioInterruptHandler(void* callbackRef) {
    XScuTimer *timer = (XScuTimer *)callbackRef;

    if (XScuTimer_IsExpired(timer)) {
        XScuTimer_ClearInterruptStatus(timer);
//        XScuTimer_LoadTimer(timer, INTERRUPT_PERIOD_US * TIME_TO_US_DIVIDER);
//        XScuTimer_Start(timer);
        
        #ifdef PRINT_DURATION
            XTime start, stop;
            XTime_GetTime(&start);		
        #endif

        runFilters();
            
        #ifdef PRINT_DURATION
            XTime_GetTime(&stop);

            // Print duration of bandpass filter
            u32 duration = stop - start;
            static u32 count = 0;
            if (count > SAMPLE_RATE) {
                count = 0;
                // print duration of bandpass filter
                xil_printf("Duration of bandpass filter: %d\r\n", duration);
            }
            count++;
        #endif
        
        // print the time between samples
        #ifdef PRINT_DURATION
            Duration();
        #endif
    }
}

void calculateCoefficients() {
    // Calculate the coefficients for the filters
    for (int i = 0; i < FILTER_LENGTH; i++) {
        coefficients[i] = filterCoefficient(upperMidsCoefficients, UPPER_MIDS_LENGTH, i) +
                          filterCoefficient(presenceCoefficients, PRESENCE_LENGTH, i) +
                          filterCoefficient(brillianceCoefficients, BRILLIANCE_LENGTH, i) +
                          filterCoefficient(openAirCoefficients, OPEN_AIR_LENGTH, i);
    }
}

double filterCoefficient(const double *coefficients, int filterLength, int index) {
    if (index < 0 || index >= filterLength) {
        return 0;
    }
    return coefficients[index];
}

// Main function to run the filters
void runFilters() {
    // Read latest data
    audioData audio;
    readAudio(&audio);

    // Update the audio buffer
    addToAudioBuffer(&audio);

    // Init apply the filters
    audioData result;
    result.left = 0;
    result.right = 0;

    // Apply the FIR filter
    audioData temp;
    for (int i = 0; i < 51; i++) {
        getFromAudioBuffer(&temp, i);
        result.left += temp.left * coefficients[i];
        result.right += temp.right * coefficients[i];
    }

    // Set volume
    // volumeBoost(&result, 20.0);

    // Write the audio result
    writeAudio(&result);
}

// Boost the volume of the audio data
void volumeBoost(audioData *audio, float volumeFactor) {
    audio->left *= volumeFactor;
    audio->right *= volumeFactor;
}

// Add audio data to the buffer
void addToAudioBuffer(audioData *audio) {
    audioBuffer[audioBufferIndex] = *audio;
    audioBufferIndex = (audioBufferIndex + 1) % AUDIO_BUFFER_SIZE;
}

// Get audio data from the buffer, using a decrement value relative to the current time
void getFromAudioBuffer(audioData *audio, int decr) {
    int index = (audioBufferIndex - decr) % AUDIO_BUFFER_SIZE;
    if (index < 0) {
        index += AUDIO_BUFFER_SIZE;
    }
    *audio = audioBuffer[index];
}
